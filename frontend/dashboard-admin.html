<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="assets/css/style.css" />
  <script type="module" src="assets/js/script.js" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <title>Admin Panel - n1Human</title>
  <style>
    .dashboard-container { max-width: 1200px; margin: 120px auto 50px; padding: 0 20px; }
    .header-card { background: #1a1a1a; border-left: 5px solid #00ff00; padding: 20px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
    
    /* Tabs */
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab-btn { background: #111; border: 1px solid #333; color: #aaa; padding: 10px 20px; cursor: pointer; text-transform: uppercase; font-weight: bold; }
    .tab-btn.active { background: #00ff00; color: #000; border-color: #00ff00; }
    
    .view-section { display: none; background: #050505; padding: 20px; border: 1px solid #222; }
    .view-section.active { display: block; animation: fadeIn 0.3s; }

    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .btn-create { background: #fff; color: #000; padding: 10px 20px; border: none; cursor: pointer; font-weight: bold; }
    
    .admin-table { width: 100%; border-collapse: collapse; }
    .admin-table th, .admin-table td { padding: 12px; text-align: left; border-bottom: 1px solid #222; }
    .admin-table th { background: #111; color: #aaa; text-transform: uppercase; font-size: 0.8rem; }
    .action-btn { background: none; border: none; cursor: pointer; margin-right: 10px; color: #fff; font-size: 1rem; }
    .action-btn:hover { color: #00ff00; }
    .action-btn.delete:hover { color: #ff4444; }

    /* Modal Styles */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: #111; border: 1px solid #333; padding: 30px; width: 100%; max-width: 500px; position: relative; }
    .modal-close { position: absolute; top: 10px; right: 15px; color: #fff; cursor: pointer; font-size: 1.5rem; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9rem; }
    .form-group input, .form-group select { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: #fff; }
    .btn-save { width: 100%; padding: 12px; background: #00ff00; color: #000; font-weight: bold; border: none; cursor: pointer; }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>
  
  <n1-navbar></n1-navbar>

  <div class="dashboard-container">
    <div class="header-card">
      <div>
        <h1>Panel de Administración</h1>
        <p>Gestión Global</p>
      </div>
      <button id="logout-btn" style="background:transparent; border:1px solid #fff; color:#fff; padding:5px 15px; cursor:pointer;">Salir</button>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-target="inventory">Inventario</button>
      <button class="tab-btn" data-target="orders">Ventas</button>
    </div>

    <!-- Inventory View -->
    <div id="inventory" class="view-section active">
      <div class="section-header">
        <h2>Productos</h2>
        <button id="btn-open-create" class="btn-create">+ Nuevo</button>
      </div>
      <table class="admin-table">
        <thead>
          <tr><th>ID</th><th>Producto</th><th>Categoría</th><th>Precio</th><th>Acciones</th></tr>
        </thead>
        <tbody id="inventory-body"></tbody>
      </table>
    </div>

    <!-- Orders View -->
    <div id="orders" class="view-section">
      <div class="section-header">
        <h2>Pedidos Recientes</h2>
        <button class="btn-create" onclick="alert('Exportando CSV...')">Exportar</button>
      </div>
      <table class="admin-table">
        <thead>
          <tr><th>Pedido</th><th>Cliente</th><th>Fecha</th><th>Total</th><th>Items</th><th>Estado</th></tr>
        </thead>
        <tbody id="orders-body">
           <tr><td colspan="6" style="text-align:center;">Cargando ventas...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal CRUD (Mismo de antes) -->
  <div class="modal-overlay" id="crud-modal">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <h2 id="modal-title" style="margin-bottom: 20px;">Producto</h2>
      <form id="product-form">
        <input type="hidden" id="prod-id">
        <div class="form-group"><label>Nombre</label><input type="text" id="prod-name" required></div>
        <div class="form-group">
          <label>Categoría</label>
          <select id="prod-cat">
            <option value="camisas">Camisas</option><option value="remeras">Remeras</option><option value="accesorios">Accesorios</option>
          </select>
        </div>
        <div class="form-group"><label>Precio</label><input type="number" id="prod-price" step="0.01" required></div>
        <div class="form-group"><label>Imagen</label><input type="text" id="prod-img" value="assets/img/logo.png"></div>
        <button type="submit" class="btn-save">Guardar</button>
      </form>
    </div>
  </div>

  <n1-footer></n1-footer>

  <script type="module">
    import { authService } from './assets/js/services/AuthService.js';
    import { productService } from './assets/js/services/ProductService.js';
    import { orderService } from './assets/js/services/OrderService.js';

    // Auth Guard
    if (!authService.isAuthenticated() || !authService.isAdmin()) {
      window.location.href = 'n1humanLogin.html';
    }

    document.getElementById('logout-btn').addEventListener('click', () => authService.logout());

    // Tab Logic
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        
        btn.classList.add('active');
        document.getElementById(btn.dataset.target).classList.add('active');
        
        if (btn.dataset.target === 'orders') loadOrders();
      });
    });

    // --- Inventory Logic ---
    const tbodyInv = document.getElementById('inventory-body');
    const modal = document.getElementById('crud-modal');
    const form = document.getElementById('product-form');

    async function refreshInventory() {
      await productService.init();
      const products = productService.getAll();
      tbodyInv.innerHTML = products.map(p => `
        <tr>
          <td>#${p.id}</td>
          <td><div style="display:flex;align-items:center;gap:10px;"><img src="${p.image}" style="width:30px;height:30px;object-fit:cover;border-radius:4px;">${p.name}</div></td>
          <td>${p.category}</td>
          <td>$${p.price}</td>
          <td>
            <button class="action-btn edit" data-id="${p.id}"><i class="fas fa-edit"></i></button>
            <button class="action-btn delete" data-id="${p.id}"><i class="fas fa-trash"></i></button>
          </td>
        </tr>
      `).join('');
    }

    // --- Orders Logic ---
    const tbodyOrd = document.getElementById('orders-body');
    
    function loadOrders() {
      const orders = orderService.getAll().sort((a,b) => new Date(b.date) - new Date(a.date));
      if (orders.length === 0) {
        tbodyOrd.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#666;">No hay ventas registradas.</td></tr>';
        return;
      }
      
      tbodyOrd.innerHTML = orders.map(o => `
        <tr>
          <td><span style="color:#00ff00;">#${o.id}</span></td>
          <td>
            <strong>${o.userName || 'Usuario'}</strong><br>
            <small style="color:#666;">${o.userEmail}</small>
          </td>
          <td>${new Date(o.date).toLocaleDateString()}</td>
          <td>$${parseFloat(o.total).toFixed(2)}</td>
          <td>${o.items.length}</td>
          <td><span style="background:#1a3d1a; color:#4caf50; padding:2px 6px; border-radius:4px; font-size:0.7rem;">${o.status}</span></td>
        </tr>
      `).join('');
    }

    // ... (Event Delegation for Edit/Delete same as before) ...
    tbodyInv.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const id = btn.dataset.id;
      if (btn.classList.contains('delete')) {
        if(confirm('Eliminar?')) { productService.delete(id); refreshInventory(); }
      } 
      if (btn.classList.contains('edit')) openModal(id);
    });

    function openModal(id = null) {
      modal.classList.add('active');
      const title = document.getElementById('modal-title');
      if (id) {
        title.innerText = 'Editar';
        const p = productService.getById(id);
        document.getElementById('prod-id').value = p.id;
        document.getElementById('prod-name').value = p.name;
        document.getElementById('prod-cat').value = p.category;
        document.getElementById('prod-price').value = p.price;
        document.getElementById('prod-img').value = p.image;
      } else {
        title.innerText = 'Nuevo';
        form.reset();
        document.getElementById('prod-id').value = '';
        document.getElementById('prod-img').value = 'assets/img/logo.png';
      }
    }

    document.getElementById('btn-open-create').addEventListener('click', () => openModal());
    document.querySelector('.modal-close').addEventListener('click', () => modal.classList.remove('active'));

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const id = document.getElementById('prod-id').value;
      const productData = {
        name: document.getElementById('prod-name').value,
        category: document.getElementById('prod-cat').value,
        price: parseFloat(document.getElementById('prod-price').value),
        image: document.getElementById('prod-img').value
      };
      if (id) productService.update(id, productData);
      else productService.create(productData);
      modal.classList.remove('active');
      refreshInventory();
    });

    refreshInventory();
  </script>
</body>
</html>
